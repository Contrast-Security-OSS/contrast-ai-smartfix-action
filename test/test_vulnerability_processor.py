#!/usr/bin/env python3
"""Unit tests for VulnerabilityProcessor class.

This module tests the VulnerabilityProcessor functionality including:
- Vulnerability data processing from API responses
- Domain object creation and validation
- Context management for remediation workflows
- Error handling and validation
"""

import unittest

# Test setup imports (path is set up by conftest.py)
from src.smartfix.domains.vulnerability.processor import (
    VulnerabilityProcessor
)
from src.smartfix.domains.vulnerability.context import (
    RemediationContext, PromptConfiguration, BuildConfiguration, RepositoryConfiguration
)
from src.smartfix.domains.vulnerability.models import (
    Vulnerability, VulnerabilitySeverity
)


class TestVulnerabilityProcessor(unittest.TestCase):
    """Test cases for VulnerabilityProcessor."""

    def setUp(self):
        """Set up test environment."""
        # Create processor instance
        self.processor = VulnerabilityProcessor()

        # Create valid test configuration objects using direct construction
        self.prompts = PromptConfiguration(
            fix_system_prompt='Test fix system prompt',
            fix_user_prompt='Test fix user prompt',
            qa_system_prompt='Test QA system prompt',
            qa_user_prompt='Test QA user prompt'
        )

        self.build_config = BuildConfiguration(
            build_command='npm test',
            formatting_command='npm run format'
        )

        self.repo_config = RepositoryConfiguration(
            repo_path='/test/workspace',
            base_branch='main',
            working_branch='fix-branch',
            remote_url='https://github.com/test/repo.git'
        )

        # Create a valid test vulnerability
        self.valid_vulnerability = Vulnerability(
            uuid="test-vuln-123",
            title="Test Vulnerability",
            rule_name="test-rule",
            severity=VulnerabilitySeverity.MEDIUM,
            remediation_id="test-remediation-123",
            description="A test vulnerability for unit testing"
        )

        # Sample API data for testing
        self.sample_api_data = {
            'remediationId': 'api-remediation-456',
            'vulnerabilityUuid': 'api-vuln-456',
            'vulnerabilityTitle': 'API Vulnerability',
            'vulnerabilityRuleName': 'api-rule',
            'vulnerabilityStatus': 'OPEN',
            'vulnerabilitySeverity': 'HIGH',
            'file': 'api_test.py',
            'lineNumber': 100
        }

    def test_processor_initialization(self):
        """Test processor initializes correctly."""
        processor = VulnerabilityProcessor()
        self.assertIsNotNone(processor)

    def test_process_api_vulnerability_data_valid(self):
        """Test processing valid API vulnerability data."""
        vulnerability = self.processor.process_api_vulnerability_data(self.sample_api_data)

        self.assertIsInstance(vulnerability, Vulnerability)
        self.assertEqual(vulnerability.uuid, 'api-vuln-456')
        self.assertEqual(vulnerability.title, 'API Vulnerability')
        self.assertEqual(vulnerability.severity, VulnerabilitySeverity.HIGH)

    def test_create_remediation_context_success(self):
        """Test successful creation of remediation context with API-provided ID."""
        api_provided_id = "api-remediation-789"

        context = self.processor.create_remediation_context(
            remediation_id=api_provided_id,
            vulnerability=self.valid_vulnerability,
            prompts=self.prompts,
            build_config=self.build_config,
            repo_config=self.repo_config
        )

        self.assertIsInstance(context, RemediationContext)
        self.assertEqual(context.remediation_id, api_provided_id)
        self.assertEqual(context.vulnerability, self.valid_vulnerability)
        self.assertEqual(context.prompts, self.prompts)
        self.assertEqual(context.build_config, self.build_config)
        self.assertEqual(context.repo_config, self.repo_config)


if __name__ == '__main__':
    unittest.main()
