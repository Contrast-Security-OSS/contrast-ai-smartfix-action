"""Tests for vulnerability models without VulnerabilityStatus.

This module contains test cases for the vulnerability domain models,
focusing on the core functionality after removing status-based features.
"""

import unittest

# Test setup imports (path is set up by conftest.py)
from src.smartfix.domains.vulnerability.models import (
    Vulnerability, VulnerabilitySeverity
)


class TestVulnerabilitySeverity(unittest.TestCase):
    """Test cases for VulnerabilitySeverity enum."""

    def test_enum_values(self):
        """Test that all expected severity values exist."""
        expected_values = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'NOTE']
        actual_values = [severity.value for severity in VulnerabilitySeverity]
        self.assertEqual(set(expected_values), set(actual_values))

    def test_severity_creation(self):
        """Test severity enum creation."""
        critical_severity = VulnerabilitySeverity.CRITICAL
        low_severity = VulnerabilitySeverity.LOW

        self.assertEqual(critical_severity.value, 'CRITICAL')
        self.assertEqual(low_severity.value, 'LOW')


class TestVulnerability(unittest.TestCase):
    """Test cases for Vulnerability aggregate root."""

    def setUp(self):
        """Set up test fixtures."""
        self.sample_vulnerability = Vulnerability(
            uuid="vuln-123-456-789",
            title="SQL Injection in login function",
            rule_name="sql-injection",
            severity=VulnerabilitySeverity.HIGH,
            description="Potential SQL injection vulnerability detected",
            cwe_id="CWE-89"
        )

    def test_vulnerability_creation(self):
        """Test vulnerability instance creation."""
        vuln = Vulnerability(
            uuid="test-uuid",
            title="Test Vulnerability",
            rule_name="test-rule",
            severity=VulnerabilitySeverity.MEDIUM
        )

        self.assertEqual(vuln.uuid, "test-uuid")
        self.assertEqual(vuln.title, "Test Vulnerability")
        self.assertEqual(vuln.rule_name, "test-rule")
        self.assertEqual(vuln.severity, VulnerabilitySeverity.MEDIUM)

    def test_vulnerability_properties(self):
        """Test vulnerability property access."""
        self.assertEqual(self.sample_vulnerability.uuid, "vuln-123-456-789")
        self.assertEqual(self.sample_vulnerability.title, "SQL Injection in login function")
        self.assertEqual(self.sample_vulnerability.rule_name, "sql-injection")
        self.assertEqual(self.sample_vulnerability.severity, VulnerabilitySeverity.HIGH)

    def test_to_dict(self):
        """Test vulnerability dictionary conversion."""
        vuln = Vulnerability(
            uuid="dict-test",
            title="Dict Test Vulnerability",
            rule_name="dict-rule",
            severity=VulnerabilitySeverity.LOW
        )

        vuln_dict = vuln.to_dict()

        self.assertEqual(vuln_dict['uuid'], "dict-test")
        self.assertEqual(vuln_dict['title'], "Dict Test Vulnerability")
        self.assertEqual(vuln_dict['rule_name'], "dict-rule")
        self.assertEqual(vuln_dict['severity'], VulnerabilitySeverity.LOW.value)

    def test_from_api_data(self):
        """Test vulnerability creation from API data."""
        api_data = {
            'vulnerabilityUuid': 'api-uuid-123',
            'vulnerabilityTitle': 'API Test Vulnerability',
            'vulnerabilityRuleName': 'api-test-rule',
            'vulnerabilitySeverity': 'HIGH',
            'remediationId': 'remediation-123',
            'description': 'Test description',
            'cweId': 'CWE-123',
            'metadata': {'test': 'data'}
        }

        vuln = Vulnerability.from_api_data(api_data)

        self.assertEqual(vuln.uuid, 'api-uuid-123')
        self.assertEqual(vuln.title, 'API Test Vulnerability')
        self.assertEqual(vuln.rule_name, 'api-test-rule')
        self.assertEqual(vuln.severity, VulnerabilitySeverity.HIGH)
        self.assertEqual(vuln.remediation_id, 'remediation-123')
        self.assertEqual(vuln.description, 'Test description')
        self.assertEqual(vuln.cwe_id, 'CWE-123')
        self.assertEqual(vuln.metadata, {'test': 'data'})

    def test_from_api_data_minimal(self):
        """Test vulnerability creation from minimal API data."""
        api_data = {
            'vulnerabilityUuid': 'minimal-uuid',
            'vulnerabilityTitle': 'Minimal Vulnerability',
            'vulnerabilityRuleName': 'minimal-rule',
            'vulnerabilitySeverity': 'MEDIUM'
        }

        vuln = Vulnerability.from_api_data(api_data)

        self.assertEqual(vuln.uuid, 'minimal-uuid')
        self.assertEqual(vuln.title, 'Minimal Vulnerability')
        self.assertEqual(vuln.rule_name, 'minimal-rule')
        self.assertEqual(vuln.severity, VulnerabilitySeverity.MEDIUM)
        self.assertIsNone(vuln.remediation_id)
        self.assertIsNone(vuln.description)
        self.assertIsNone(vuln.cwe_id)
        self.assertEqual(vuln.metadata, {})


if __name__ == '__main__':
    unittest.main()
