name: Build and Test

on:
  push:
    branches:
      - '*' # Run on all branches

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # Enable built-in pip caching

      # Install uv tool for dependency management
      - name: Install uv
        shell: bash
        run: |
          echo ""
          echo "ðŸ“¦ Installing uv package manager..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            pip install uv==0.7.15 > uv-install.log || (cat uv-install.log && exit 1)
          else
            pip install uv==0.7.15 > /tmp/uv-install.log || (cat /tmp/uv-install.log && exit 1)
          fi
          echo "âœ… uv installed successfully"

      # Install dependencies using uv (Linux/macOS)
      - name: Install dependencies with uv
        if: runner.os == 'Linux' || runner.os == 'macOS'
        shell: bash
        run: |
          echo ""
          echo "ðŸ“¦ Installing Python packages using uv..."
          echo "ðŸ“Ž Using lockfile for deterministic installation"
          uv pip sync --system ${{ github.action_path }}/src/requirements.lock > /tmp/uv-output.log || (cat /tmp/uv-output.log && exit 1)
          echo "âœ… Python dependencies installed successfully"

      - name: Run tests
        run: PYTHONPATH=${{ github.workspace }}/src python -m unittest discover -s test -p "test*.py"
        env:
          BASE_BRANCH: "${{ github.event.repository.default_branch }}"
          BUILD_COMMAND: "echo 'Mock build command for testing'"
          FORMATTING_COMMAND: "echo 'Mock formatting command for testing'"
          GITHUB_TOKEN: ${{ github.token }}
          CONTRAST_HOST: "https://mock.contrastsecurity.com"
          CONTRAST_ORG_ID: "mock-org-id"
          CONTRAST_APP_ID: "mock-app-id"
          CONTRAST_AUTHORIZATION_KEY: "mock-auth-key"
          CONTRAST_API_KEY: "mock-api-key"
          DEBUG_MODE: "true"
