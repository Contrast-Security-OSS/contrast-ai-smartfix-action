"""Vulnerability Processing Logic

This module contains the VulnerabilityProcessor class that handles the main
processing logic for single vulnerability remediation including workflow
coordination, context management, and remediation state transitions.

The VulnerabilityProcessor serves as the domain service for processing
individual vulnerabilities through the complete remediation workflow.
"""

from typing import Dict, Any
import logging

from .models import Vulnerability
from .context import RemediationContext, PromptConfiguration, BuildConfiguration, RepositoryConfiguration


logger = logging.getLogger(__name__)


class VulnerabilityProcessingError(Exception):
    """Exception raised when vulnerability processing fails."""
    pass


class RemediationWorkflowError(Exception):
    """Exception raised when remediation workflow fails."""
    pass


class VulnerabilityProcessor:
    """
    Domain service for processing individual vulnerabilities through remediation workflow.

    The VulnerabilityProcessor handles the complete processing logic for a single
    vulnerability including workflow coordination, context management, and state
    transitions throughout the remediation process.

    This class follows Domain-Driven Design principles as a domain service,
    coordinating between the Vulnerability aggregate, RemediationContext, and
    external services to complete the remediation workflow.

    Key Responsibilities:
    - Process individual vulnerabilities through complete remediation workflow
    - Coordinate between agents (fix generation, QA, testing)
    - Manage remediation context and workflow state
    - Handle workflow transitions and error recovery
    - Provide progress tracking and telemetry integration

    Design Notes:
    - Focuses on single vulnerability processing (not batch operations)
    - Stateless service design for better testability
    - Uses RemediationContext for maintaining workflow state
    - Relies on Vulnerability model for data validation (no duplicate validation)
    - Integrates with external agents and services
    - Implements comprehensive error handling and recovery
    """

    def __init__(self, **kwargs):
        """
        Initialize a new VulnerabilityProcessor instance.

        Args:
            **kwargs: Additional processor configuration options
        """
        self._config = kwargs

        logger.info("VulnerabilityProcessor initialized for single vulnerability processing")

    def create_remediation_context(
        self,
        remediation_id: str,
        vulnerability: Vulnerability,
        prompts: PromptConfiguration,
        build_config: BuildConfiguration,
        repo_config: RepositoryConfiguration,
        **kwargs
    ) -> RemediationContext:
        """
        Create a remediation context for processing a vulnerability.

        Args:
            remediation_id: API-provided remediation ID for tracking
            vulnerability: Vulnerability to create context for (already validated by model)
            prompts: AI prompts configuration
            build_config: Build and testing configuration
            repo_config: Repository configuration
            **kwargs: Additional context metadata

        Returns:
            New RemediationContext configured for the vulnerability

        Raises:
            VulnerabilityProcessingError: If context creation fails
        """
        try:
            # Create and return context using API-provided remediation ID
            # Note: Vulnerability is already validated by its model's __post_init__ method
            context = RemediationContext(
                remediation_id=remediation_id,
                vulnerability=vulnerability,
                prompts=prompts,
                build_config=build_config,
                repo_config=repo_config
            )

            logger.info(f"Created remediation context {remediation_id} for vulnerability {vulnerability.uuid}")
            return context

        except Exception as e:
            error_msg = f"Failed to create remediation context for vulnerability {vulnerability.uuid}: {e}"
            logger.error(error_msg)
            raise VulnerabilityProcessingError(error_msg) from e

    def process_api_vulnerability_data(self, api_data: Dict[str, Any]) -> Vulnerability:
        """
        Process vulnerability data from external API.

        Transforms raw API data into a validated Vulnerability domain object
        with proper error handling and data validation.

        Args:
            api_data: Raw vulnerability data from external API

        Returns:
            New Vulnerability instance

        Raises:
            VulnerabilityProcessingError: If API data processing fails
        """
        try:
            # Use the Vulnerability.from_api_data class method for conversion
            vulnerability = Vulnerability.from_api_data(api_data)

            logger.info(f"Successfully processed API data for vulnerability {vulnerability.uuid}")
            return vulnerability

        except (KeyError, ValueError) as e:
            error_msg = f"Failed to process API vulnerability data: {e}"
            logger.error(error_msg)
            raise VulnerabilityProcessingError(error_msg) from e

    def __str__(self) -> str:
        """String representation of the processor."""
        return f"VulnerabilityProcessor(config_keys={len(self._config)})"

    def __repr__(self) -> str:
        """Debug representation of the processor."""
        return f"VulnerabilityProcessor(config={self._config})"
