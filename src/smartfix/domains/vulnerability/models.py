"""Vulnerability Data Models

This module contains the core vulnerability data models that represent
security vulnerabilities based on the actual API structure used by the system.

Simplified to match the real-world usage in main.py and contrast_api.py.
"""

from dataclasses import dataclass
from enum import Enum
from typing import Optional, Dict, Any


class VulnerabilitySeverity(Enum):
    """Enumeration of vulnerability severity levels."""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    NOTE = "NOTE"


@dataclass
class Vulnerability:
    """
    Domain model representing a security vulnerability.

    Simplified to match actual API data structure and system usage.
    Based on the actual fields received from Contrast API.
    """
    uuid: str
    title: str
    rule_name: str
    severity: VulnerabilitySeverity
    remediation_id: Optional[str] = None
    description: Optional[str] = None
    cwe_id: Optional[str] = None
    metadata: Optional[Dict[str, Any]] = None

    def __post_init__(self):
        """Validate after initialization."""
        self._validate_required_fields()
        if self.metadata is None:
            self.metadata = {}

    def _validate_required_fields(self) -> None:
        """
        Validate that all required fields are present and valid.

        Raises:
            ValueError: If validation fails
        """
        if not self.uuid:
            raise ValueError("Vulnerability UUID is required")
        if not self.title:
            raise ValueError("Vulnerability title is required")
        if not self.rule_name:
            raise ValueError("Vulnerability rule name is required")

    @classmethod
    def from_api_data(cls, api_data: Dict[str, Any]) -> "Vulnerability":
        """
        Create a Vulnerability instance from Contrast API response data.

        Args:
            api_data: Dictionary containing vulnerability data from API

        Returns:
            Vulnerability instance

        Raises:
            ValueError: If required fields are missing or invalid
            KeyError: If expected API keys are not present
        """
        # Map API severity strings to enum values
        severity_mapping = {
            'CRITICAL': VulnerabilitySeverity.CRITICAL,
            'HIGH': VulnerabilitySeverity.HIGH,
            'MEDIUM': VulnerabilitySeverity.MEDIUM,
            'LOW': VulnerabilitySeverity.LOW,
            'NOTE': VulnerabilitySeverity.NOTE,
        }

        # Extract required fields
        uuid = api_data['vulnerabilityUuid']
        title = api_data['vulnerabilityTitle']
        rule_name = api_data['vulnerabilityRuleName']

        # Map severity
        severity_str = api_data['vulnerabilitySeverity']
        severity = severity_mapping.get(severity_str, VulnerabilitySeverity.MEDIUM)

        return cls(
            uuid=uuid,
            title=title,
            rule_name=rule_name,
            severity=severity,
            remediation_id=api_data.get('remediationId'),
            description=api_data.get('description'),
            cwe_id=api_data.get('cweId'),
            metadata=api_data.get('metadata', {})
        )

    def to_dict(self) -> Dict[str, Any]:
        """
        Convert vulnerability to dictionary representation.

        Returns:
            Dictionary containing vulnerability data
        """
        return {
            'uuid': self.uuid,
            'title': self.title,
            'rule_name': self.rule_name,
            'severity': self.severity.value,
            'remediation_id': self.remediation_id,
            'description': self.description,
            'cwe_id': self.cwe_id,
            'metadata': self.metadata
        }
