## [14:53] Planning: AIML-337 - Add Command Allowlist Validation to SmartFix

**Key Learnings:**

- SmartFix currently executes arbitrary bash commands from `BUILD_COMMAND` and `FORMATTING_COMMAND` environment variables using `shell=True` without validation
- Security vulnerability exists in `build_runner.py:54` and `formatter.py:56` where commands are executed directly
- Early validation in `Config.__init__()` is the right pattern for SmartFix - follows existing configuration validation approach
- Command allowlist needs to be comprehensive to support all language ecosystems SmartFix handles (Java, .NET, Python, PHP, NodeJS)

**Architectural Decisions:**

- **Validation location**: Config class initialization (fail-fast pattern)
- **Validation approach**: Moderate strictness (option B)
  - Allow executables from comprehensive allowlist
  - Allow safe operators: `&&`, `||`, `;`, `|`
  - Allow redirects to relative paths only (no `..` traversal, no absolute paths)
  - Block dangerous patterns (command substitution, eval, exec, etc.)
- **Shell script execution**: Allow `sh`/`bash` to execute `.sh` files only, block `-c` flag for inline execution
- **Parser design**: Tokenize by operators, validate each segment independently

**Risks Identified:**

- Regex patterns for dangerous command detection need thorough testing to avoid bypasses
- Command parsing needs to handle edge cases (quoted strings, escaped characters)
- May need to expand allowlist as new build tools are adopted by users

**Implementation Structure:**

1. Create `src/smartfix/config/command_validator.py` module
2. Integrate into `Config.__init__()` after reading commands
3. Comprehensive test coverage in `test/test_command_validation.py`
4. Documentation updates in README.md and security.md

**Follow-up Questions:**

- Should we provide a way for users to extend the allowlist via configuration?
- Should we log/telemetry track which commands are being validated?
- Should we provide warnings for deprecated build tools before blocking them?

---
