# Contrast AI SmartFix \- GitHub Copilot Agent Documentation

## Legal Disclaimer

When you use Contrast AI SmartFix, you agree that your code and other data will be submitted to an LLM of your choice.  Both the submission of data to the LLM and the output generated by the LLM will be subject to the terms of service of that LLM.   Use of Contrast AI SmartFix is entirely at your own risk.

## Introduction

For Git repositories on GitHub, Contrast Security customers can choose to use one of three different coding agents to remediate vulnerabilities - the SmartFix Coding Agent, GitHub Copilot, or Claude Code.  This document focuses on configuring the SmartFix Action to use the GitHub Copilot coding agent.

When assigned to a SmartFix-created GitHub Issue describing a Contrast-discovered vulnerability, GitHub Copilot will analyze, fix, and validate a vulnerability remediation. This agent creates a complete fix, ensures your project builds successfully, and verifies that existing tests continue to pass.  When it successfully remediates a vulnerability, GitHub Copilot will open a draft PR containing the remediation.

**Key Benefits:**

* **Automated Remediation:** Reduces the manual effort and time required to fix vulnerabilities.
* **Developer-Focused:** Delivers fixes as PRs directly in your GitHub repository, fitting naturally into existing workflows.
* **Runtime Context:** Leverages Contrast Assess's runtime analysis (IAST) to provide more accurate and relevant fixes.

## Getting Started

### Prerequisites

* **Contrast Assess:** You need an active Contrast Assess deployment identifying vulnerabilities in your application.
* **GitHub:** Your project must be hosted on GitHub and use GitHub Actions.  In the GitHub repository's Settings, enable the Actions > General > Workflow Permissions checkbox for "Allow GitHub Actions to create and approve pull requests".
* **GitHub Copilot Requirements:**
  * GitHub repository with **Issues** and **GitHub Copilot** enabled
  * GitHub Personal Access Token (PAT) with:
    * `meta` (read permissions)
    * `pulls` (read-write permissions)
    * `issues` (read-write permissions)
  * **Suggestion:** Set up a GitHub service account and use that to make the PAT for more explicit tracking of SmartFix's work in GitHub.
* **Contrast API Credentials:** You will need your Contrast Host, Organization ID, Application ID, Authorization Key, and API Key.

Set the gathered values as secrets and variables for the GitHub repository at Settings tab > Secrets and Variables in the sidebar > Actions.

Secrets:
* CONTRAST_AUTHORIZATION_KEY
* CONTRAST_API_KEY
* PAT_TOKEN

Variables:
* CONTRAST_HOST (The host name of your Contrast SaaS instance, e.g. 'app.contrastsecurity.com')
* CONTRAST_ORG_ID (The UUID of your Contrast organization)
* CONTRAST_APP_ID (The UUID that is specific to the application in this repository.)
* Any other non-secret values, such as the AWS region for a Bedrock-provided LLM

### Installation and Configuration for GitHub Copilot Coding Agent

This is an example variation of the workflow file for use with the GitHub Copilot coding agent:

```
name: Contrast AI SmartFix

on:
  pull_request:
    types:
      - closed
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC, adjust as needed
  workflow_dispatch: # Allows manual triggering

jobs:
  run_smartfix:
    name: SmartFix
    runs-on: ubuntu-latest
    steps:
      # When using GitHub Copilot, it is unnecessary to authenticate with an LLM API

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine SmartFix Job Type
        id: determine_job_name
        shell: bash
        run: |
          if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "job_name=Notify Contrast on PR Merge" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.merged }}" == "false" ]]; then
            echo "job_name=Handle PR Close" >> $GITHUB_OUTPUT
          else
            echo "job_name=Run Contrast AI SmartFix - Generate Fixes" >> $GITHUB_OUTPUT
          fi
      - name: ${{ steps.determine_job_name.outputs.job_name }}
        uses: Contrast-Security-OSS/contrast-ai-smartfix-action@v1 # Replace with the latest version
        with:
          # Contrast Configuration
          contrast_host: ${{ vars.CONTRAST_HOST }} # The host name of your Contrast SaaS instance, e.g. 'app.contrastsecurity.com'
          contrast_org_id: ${{ vars.CONTRAST_ORG_ID }} # The UUID of your Contrast organization
          contrast_app_id: ${{ vars.CONTRAST_APP_ID }} # The UUID that is specific to the application in this repository.
          contrast_authorization_key: ${{ secrets.CONTRAST_AUTHORIZATION_KEY }}
          contrast_api_key: ${{ secrets.CONTRAST_API_KEY }}

          # GitHub Configuration
          github_token: ${{ secrets.PAT_TOKEN }} # Necessary for creating Issues and assigning to Copilot.  This token should have read permission for metadata and read-write permission for issues and pulls.  A best practice is to have an GitHub Organization service account create the PAT (an Organization admin may need to approve it)
          base_branch: '${{ github.event.repository.default_branch }}' # This will default to your repo default branch (other common base branches are 'main', 'master' or 'develop')
          coding_agent: 'GITHUB_COPILOT' # Specify the use of GitHub Copilot instead of the default SmartFix internal coding agent

          # Other Optional Inputs (see action.yml for defaults and more options)
          # max_open_prs: 5 # This is the maximum limit for the number of PRs that SmartFix will have open at single time

```

**Important:**

* Store all sensitive values (API keys, tokens) as GitHub Secrets in your repository or Github organization settings.
* Replace `v1` with the specific version of the SmartFix GitHub Action you intend to use.
* The `contrast_app_id` must correspond to the Contrast Application ID for the code in the repository where this action runs.  To find the app ID, visit the application page in the Contrast web UI, then use the last UUID in the URL (immediately after `/applications/`) as the app ID value.
* Set the `coding_agent` value to `GITHUB_COPILOT` to force the SmartFix GitHub Action to use the GitHub Copilot coding agent.

### Supported Languages

Per GitHub's official [documentation](https://docs.github.com/en/get-started/learning-about-github/github-language-support#core-languages-supported-by-github-features), GitHub Copilot supports Java, C#, JavaScript, TypeScript, Python, PHP, Go, Ruby, and more.

### Supported GitHub Runners

* **Ubuntu, Windows:** The Windows and Ubuntu GitHub runners have both been tested and work well for the SmartFix action.
* **MacOS, and Self-hosted:** No matter the runner you choose, please ensure that your `smartfix.yml` workflow file installs the necessary tools and sets up any PATH or other environmental variables so that your project's build and formatting commands can run as planned.

Note: the SmartFix action's setup steps rely on the bash shell.  Please ensure that your self-hosted runner has a bash shell available and on the PATH.  For Windows runners, SmartFix will use the Git Bash shell.

### Supported Vulnerabilities

SmartFix focuses on remediating:

* **CRITICAL** and **HIGH** severity vulnerabilities identified by Contrast Assess.
* **Exclusions:**
  * Cross-Site Request Forgery (CSRF) is currently excluded due to the complexity of fixes often requiring API changes.
  * Other specific vulnerability types may be excluded based on ongoing testing by Contrast Labs.

## How it Works

1. **Scheduled Trigger:** The GitHub Action runs on a defined schedule (e.g., daily) or can be manually triggered.
2. **Configuration Validation:** The action validates your Contrast credentials and other configuration values to ensure they are valid.
3. **Vulnerability Request:** The SmartFix agent in the action calls the Contrast backend API to request a vulnerability to fix.
4. **Prioritization:** The backend API prioritizes eligible vulnerabilities based on severity.
5. **GitHub Issue:** The SmartFix Action workflow uses the vulnerability information to open a GitHub Issue, which it then assigns to GitHub Copilot for remediation.
6. **PR Creation:** The GitHub Copilot coding agent will open a draft PR for review to resolve the vulnerability.
7. **Status Update:** The agent notifies the backend API about the PR creation as well as when the PR is either closed or merged.
8. **Looping:** Once SmartFix has finished attempting to fix a vulnerability without an exception, it will request another vulnerability to resolve from the Contrast backend.  It will continue looping in this manner until it reaches one of its ending condition states, detailed below.
9. **Throttling:** The `max_open_prs` input (default: 5\) limits the number of concurrent open PRs SmartFix will create to avoid overwhelming developers.
10. **Ending Conditions:** SmartFix has several conditions that will make it stop a workflow run:
   * If the Contrast backend reports to SmartFix that there are no more vulnerabilities of the specified severity levels to fix, SmartFix will end its workflow run.
   * If SmartFix sees that it has reached the configured `max_open_prs` number of concurrently open SmartFix PRs, it will end its workflow run.
   * If SmartFix has reached its internal time limit of 3 hours of processing time for some reason, it will stop the workflow run instead of requesting a new vulnerability to resolve.
   * If SmartFix encounters an exception of some kind, it will stop the workflow run.
11. **Exceptions:** Sometimes things go wrong.  When SmartFix cannot generate a fix for the vulnerability, it will log the reason why, try to clean up the Github feature branches that have been made for that vulnerability, and exit the workflow early.
12. **Guardrails:** SmartFix has several configurable and internal guardrails:
   * *Time limit* - SmartFix has an internal time limit of 3 hours.  If it goes over 3 hours of processing time, it will not request another vulnerability to resolve.
   * `max_open_prs` - SmartFix offers this configurable value to control the maximum number concurrently open SmartFix PRs.

## Configuration Inputs

The following are key inputs for the SmartFix GitHub Action using the GitHub Copilot coding agent. Refer to the `action.yml` in the SmartFix GitHub Action repository for a complete list and default values.

| Input | Description | Required | Default |
| :---- | :---- | :---- | :---- |
| `github_token` | GitHub PAT token for Issue and PR operations. | Yes |  |
| `base_branch` | Base branch for PRs. | No | `${{ github.event.repository.default_branch }}` |
| `contrast_host` | Contrast Security API host. | Yes |  |
| `contrast_org_id` | Contrast Organization ID. | Yes |  |
| `contrast_app_id` | Contrast Application ID for the repository. | Yes |  |
| `contrast_authorization_key` | Contrast Authorization Key. | Yes |  |
| `contrast_api_key` | Contrast API Key. | Yes |  |
| `coding_agent` | Specify that SmartFix should use Github Copilot as the coding agent. | Yes | `GITHUB_COPILOT` |
| `max_open_prs` | Maximum number of open PRs SmartFix can create. | No | `5` |
| `debug_mode` | Enable verbose logging. | No | `false` |
| `enable_full_telemetry` | Control how much telemetry data is sent back to Contrast. When set to 'true' (default), sends complete log files and build commands. When 'false', sensitive build commands and full logs are omitted. | No | `true` |

## Telemetry

SmartFix collects telemetry data to help improve the service and diagnose issues. This data includes:

* Vulnerability information (IDs and rules)
* Application metadata (programming language, frameworks)
* Configuration settings (sanitized build and formatting commands)
* Result information (PR creation status, files modified)
* Full log output

### Telemetry Configuration

* The telemetry behavior is determined by the `enable_full_telemetry` setting:
  * When `enable_full_telemetry: 'true'` (default): Sends complete logs and all configuration data
  * When `enable_full_telemetry: 'false'`: Omits both log data and sensitive build commands

### Data Handling

* All telemetry data is handled according to Contrast Security's privacy policies.

## Troubleshooting

* **Invalid Credentials:** If the action fails with errors related to Contrast authentication, double-check your `contrast_host`, `contrast_org_id`, `contrast_app_id`, `contrast_authorization_key`, and `contrast_api_key` secrets and ensure they are correctly passed to the action.
* **GitHub Copilot Errors:**
  * Ensure the that the repository / organization has GitHub Issues enabled and that GitHub Copilot has a seat available
  * Check the GitHub Action logs for specific error messages from the GitHub Copilot agent.
* **PR Creation Failures:**
  * Ensure the `PAT_token` has the necessary permissions to create and read Issues and PRs in the repository.
  * Check for branch protection rules that might prevent PR creation.
* **No Fixes Generated:**
  * Confirm there are eligible CRITICAL or HIGH severity vulnerabilities in Contrast Assess for the configured `contrast_app_id`. SmartFix only attempts to fix vulnerabilities that are in the REPORTED state.
  * Check the `max_open_prs` limit; if the number of PRs SmartFix has created that are still open matches this limit, no new PRs will be created.
  * Review the GitHub Action logs for messages indicating why vulnerabilities might have been skipped.
* **Incorrect Fixes:** The AI-generated fixes should **always** be reviewed carefully. If a fix is incorrect or incomplete:
  * Reject the PR.

## Best Practices & Recommendations

* **Review PRs Thoroughly:** Always carefully review the code changes proposed by SmartFix before merging.
* **Monitor Action Runs:** Regularly check the GitHub Action logs for successful runs and any reported problems.

## FAQ

* **Q: Can I use SmartFix if I don't use Contrast Assess?**
  * A: No, SmartFix relies on vulnerability data from Contrast Assess. In the future we plan to expand to include more.
* **Q: How often does SmartFix run?**
  * A: This is determined by the `schedule` trigger in your GitHub Actions workflow file. You can customize it.
* **Q: What happens if the AI cannot generate a fix?**
  * A: The agent will log this, and no PR will be created for that specific vulnerability attempt. It will retry on a future run.
* **Q: Can SmartFix fix multiple vulnerabilities in one PR?**
  * A: No, for the Early Access release, each PR addresses a single vulnerability.
* **Q: Will SmartFix add new library dependencies?**
  * A: Generally, SmartFix aims to use existing libraries and frameworks. We have instructed it not to make major architectural changes or add new dependencies.

---

For further assistance or to provide feedback on SmartFix, please contact your Contrast Security representative.
