# Contrast AI SmartFix \- User Documentation

## Legal Disclaimer

When you use Contrast AI SmartFix, you agree that your code and other data will be submitted to an LLM of your choice.  Both the submission of data to the LLM and the output generated by the LLM will be subject to the terms of service of that LLM.   Use of Contrast AI SmartFix is entirely at your own risk.

## Introduction

Welcome to Contrast AI SmartFix\! SmartFix is an AI-powered agent that automatically generates code fixes for vulnerabilities identified by Contrast Assess. It integrates into your developer workflow via GitHub Actions, creating Pull Requests (PRs) with proposed remediations.

**Key Benefits:**

* **Automated Remediation:** Reduces the manual effort and time required to fix vulnerabilities.
* **Developer-Focused:** Delivers fixes as PRs directly in your GitHub repository, fitting naturally into existing workflows.
* **Runtime Context:** Leverages Contrast Assess's runtime analysis (IAST) to provide more accurate and relevant fixes.

## Getting Started

### Coding Agent

SmartFix supports three distinct coding agents for vulnerability remediation on GitHub:

* **SmartFix Agent (Recommended):** Uses Contrast vulnerability data with a team of agentic AIs to analyze, fix, and validate vulnerability remediations. This agent creates a complete fix, ensures your project builds successfully, and verifies that existing tests continue to pass. Use Contrast LLM, or you can bring your own LLM provider.

* **GitHub Copilot Agent:** Leverages GitHub Copilot for vulnerability fixes through GitHub Issues. SmartFix creates a detailed GitHub Issue with vulnerability information and assigns it to GitHub Copilot for resolution. Copilot then attempts the fix and creates a Pull Request.  Requires your repository to enable GitHub Issues and Copilot.

* **Claude Code Agent:** Leverages Anthropic's Claude Code bot for vulnerability fixes through GitHub Issues. SmartFix creates a detailed GitHub Issue with vulnerability information and mentions the Claude Code bot in the Issue title. Claude Code then attempts the fix and creates a Pull Request.  Requires your repository to install the Claude Code GitHub App.

Please follow the specific setup instructions link for the coding agent of your choice:
* [SmartFix Coding Agent](https://github.com/Contrast-Security-OSS/contrast-ai-smartfix-action/blob/main/docs/smartfix_coding_agent.md)
* [GitHub Copilot](https://github.com/Contrast-Security-OSS/contrast-ai-smartfix-action/blob/main/docs/github_copilot.md)
* [Claude Code](https://github.com/Contrast-Security-OSS/contrast-ai-smartfix-action/blob/main/docs/claude_code.md)

## Key Features

* **Support for Multiple Coding Agents**: Choose to use either the internal SmartFix coding agent or GitHub Copilot to remediate your project's vulnerabilities
* **Contrast LLM or Bring Your Own LLM (BYOLLM):** For the SmartFix Coding Agent, use Contrast's managed LLM service for seamless setup with enterprise-grade security, or for advanced users who prefer their own LLM provider use the optional Bring Your Own LLM (BYOLLM) configuration. [Learn more about Contrast LLM](docs/contrast_llm_early_access.md). Note: Contrast LLM is only available with the SmartFix Coding Agent.
* **Configurable PR Throttling:** Control the volume of automated PRs using `max_open_prs`.
* **Debug Mode:** Enable `debug_mode: 'true'` for verbose logging in the GitHub Action output.

## Security

### Command Allowlist

SmartFix validates all build and format commands against a security allowlist to prevent arbitrary command execution in GitHub Actions workflows. This protection applies to the `BUILD_COMMAND` and `FORMATTING_COMMAND` configuration parameters.

#### Allowed Commands

Commands are organized by language ecosystem:

**Java:**
- `mvn`, `gradle`, `ant`, `junit`, `testng`
- `./gradlew`, `./mvnw`, `gradlew`, `mvnw`
- `google-java-format`, `checkstyle`

**.NET:**
- `dotnet`, `msbuild`, `nuget`
- `nunit-console`, `nunit3-console`, `xunit.console`, `vstest.console`, `mstest`
- `csharpier`

**Python:**
- `pip`, `pip3`, `python`, `python3`
- `pytest`, `nose2`, `unittest`, `coverage`
- `poetry`, `pipenv`, `uv`, `tox`, `virtualenv`
- `black`, `autopep8`, `yapf`, `isort`, `ruff`, `flake8`, `pylint`

**Node.js/JavaScript/TypeScript:**
- `npm`, `npx`, `yarn`, `node`, `pnpm`, `bun`
- `jest`, `mocha`, `jasmine`, `karma`, `ava`, `vitest`, `nyc`
- `prettier`, `eslint`, `standard`

**PHP:**
- `composer`, `php`, `phpunit`, `pest`, `codeception`
- `php-cs-fixer`, `phpcbf`

**Build Tools & Utilities:**
- `make`, `cmake`, `ninja`, `bazel`, `ctest`
- `echo`, `sh`, `bash`, `grep`, `sed`, `awk`, `cat`, `tee`
- `clang-format` (multi-language)

#### Allowed Operators

Commands can be chained using these operators:
- `&&` (sequential execution)
- `||` (fallback execution)
- `;` (command separator)
- `|` (pipe)

#### File Redirects

File redirects are allowed with these restrictions:
- ✅ Relative paths: `npm test > build.log`
- ✅ Append mode: `npm test >> output.txt`
- ✅ Error redirect: `npm test 2> error.log`
- ❌ Absolute paths: `npm test > /etc/passwd`
- ❌ Parent traversal: `npm test > ../../sensitive.txt`
- ❌ Home directory: `npm test > ~/secrets.txt`

#### Shell Command Restrictions

Shell commands (`sh`/`bash`) have special restrictions:
- ✅ Allowed: `sh ./build.sh`, `bash ./scripts/test.sh`
- ❌ Blocked: `sh -c "command"`, `bash -c 'code'`
- Must execute `.sh` files only

#### Blocked Patterns

These dangerous patterns are automatically blocked:
- Command substitution: `$(...)` or `` `...` ``
- Variable expansion: `${...}`
- Execution commands: `eval`, `exec`
- Dangerous operations: `rm -rf`
- Piping to shell: `curl ... | sh`, `wget ... | bash`
- Device access: `> /dev/...`

#### Examples

**Valid Commands:**
```bash
# Java
BUILD_COMMAND="mvn clean install && mvn test"

# Python
BUILD_COMMAND="pip install -r requirements.txt && pytest tests/"
FORMATTING_COMMAND="black . && isort ."

# Node.js
BUILD_COMMAND="npm install && npm test"
FORMATTING_COMMAND="prettier --write ."

# With output redirect
BUILD_COMMAND="npm test > test-results.log 2>&1"
```

**Invalid Commands (Will Be Rejected):**
```bash
# Disallowed executable
BUILD_COMMAND="wget https://example.com/script.sh"
# Error: uses disallowed command: wget

# Dangerous pattern
BUILD_COMMAND="npm install && rm -rf node_modules"
# Error: contains dangerous pattern: \brm\s+-rf

# Command substitution
BUILD_COMMAND="echo $(whoami)"
# Error: contains dangerous pattern: \$\(

# Shell inline execution
BUILD_COMMAND="sh -c 'npm install'"
# Error: shell commands can only execute .sh files

# Unsafe redirect
BUILD_COMMAND="npm test > /etc/passwd"
# Error: unsafe file redirect: /etc/passwd
```

#### Troubleshooting

**Error: "uses disallowed command"**
- Verify the command is in the allowed list above
- Check for typos in command names
- Ensure you're using standard build/test/format tools

**Error: "contains dangerous pattern"**
- Remove command substitution (`$(...)` or `` `...` ``)
- Avoid `eval`, `exec`, or `rm -rf`
- Don't pipe downloads to shell interpreters

**Error: "shell command incorrectly"**
- Shell commands must execute `.sh` files: `sh ./script.sh`
- Don't use `-c` flag for inline execution
- Create a shell script file if needed

**Error: "unsafe file redirect"**
- Use relative paths only: `> build.log` not `> /tmp/build.log`
- Avoid parent directory traversal: `../` patterns
- Don't redirect to home directory: `~/`

## FAQ

* **Q: Can I use SmartFix if I don't use Contrast Assess?**
  * A: No, SmartFix relies on vulnerability data from Contrast Assess. In the future we plan to expand to include more.
* **Q: How often does SmartFix run?**
  * A: This is determined by the `schedule` trigger in your GitHub Actions workflow file. You can customize it.
* **Q: What happens if the AI cannot generate a fix?**
  * A: The agent will log this, and no PR will be created for that specific vulnerability attempt. It will retry on a future run.
* **Q: Can SmartFix fix multiple vulnerabilities in one PR?**
  * A: No, each PR addresses a single vulnerability.
* **Q: Will SmartFix add new library dependencies?**
  * A: Generally, SmartFix aims to use existing libraries and frameworks. We have instructed it not to make major architectural changes or add new dependencies.

---

For further assistance or to provide feedback on SmartFix, please contact your Contrast Security representative.
